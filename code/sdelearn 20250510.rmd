---
title: "Statistical analysis report"
subtitle: "SD e-Learning"
author: "Nartlada Chantharojwong"
date: "`r Sys.Date()`"
output:
  word_document:
    reference_docx: word-styles-reference-01.docx
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE,
  cache = FALSE
)

# Packages
source(here::here('code', 'libraries.R'))

# Functions
source(here::here('code', 'functions.R'))
source(here::here('code', "render_toc.R"))

# Theme for gtsummary output
theme_gtsummary_compact()
```

\newpage

### Table of Contents

```{r toc, echo=FALSE}
render_toc(here::here('code', "sdelearn.rmd"))
```

```{r data}
df <- import(here('data', 'data.xlsx')) %>%
  clean_names() %>%
  mutate(
    quniv = factor(
      quniv,
      levels = c('กรมแพทย์ทหารบก (วิทยาลัยแพทยศาสตร์พระมงกุฎเกล้า/วิทยาลัยพยาบาลกองทัพบก)','คณะแพทยศาสตร์ โรงพยาบาลรามาธิบดี มหาวิทยาลัยมหิดล'),
      labels = c('Pramongkutklao Hospital','Ramathibodi Hospital')
    ),
    qtype = factor(
      qtype,
      levels = c('นักศึกษาแพทย์', 'นักศึกษาพยาบาล'),
      labels = c('Medical', 'Nurse')
    ),
    qyearf = factor(
      if_else(qtype == "Medical",
        cut(qyear, 
            breaks = c(0, 5, 6), 
            labels = c("Early clinical years", "Final clinical year"), 
            right = TRUE),
        cut(qyear, 
            breaks = c(0, 3, 4), 
            labels = c("Early clinical years", "Final clinical year"), 
            right = TRUE)
      ),
      # levels = c("Final clinical year", "Early clinical years")
    ),
    qyear = factor(
      ifelse(qyear == 2, 3, qyear),
      levels = c(3,4,5,6),
      labels = c('3rd', '4th', '5th', '6th')
    ),
    agegrp = cut(
      q11,
      breaks = c(0, 20, Inf),
      labels = c('<= 20 years', '> 20 years'),
    ),
    q12 = factor(
      q12,
      levels = c('ชาย', 'หญิง', 'ไม่ระบุ'),
      labels = c('Male', 'Female', 'Not specified')
    ),
    q13 = factor(
      q13,
      levels = c(
        'กรุงเทพและปริมณฑล',
        'ภาคเหนือ',
        'ภาคกลาง',
        'ภาคตะวันออก',
        'ภาคตะวันออกเฉียงเหนือ',
        'ภาคตะวันตก',
        'ภาคใต้',
        NA
      ),
      labels = c(
        'Bangkok and perimeters',
        'North',
        'Central',
        'East',
        'Northeast',
        'West',
        'South',
        'Not specified'
      ),
      exclude = NULL
    ),
    q13a = recode(q13,
                  "Central" = "Central, East, West",
                  "East"    = "Central, East, West",
                  "West"    = "Central, East, West"),
    q21 = factor(
      q21,
      levels = c('เคย', 'ไม่เคย'),
      labels = c('Yes', 'No')),
    across(num_range('q21', 1:4), ~ factor(
      .x,
      levels = c('ใช่', 'ไม่ใช่'),
      labels = c('Yes', 'No')
    )),
    across(c('q221', 'q231', 'q241', 'q26', 'q27'), ~ factor(
      .x,
      levels = c('กังวลมาก', 'ค่อนข้างกังวล', 'กังวลเล็กน้อย', 'ไม่กังวลเลย'),
      labels = c(
        'Very worried',
        'Somewhat worried',
        'A little worried',
        'Not at all worried'
      )
    )),
    across(c('q221', 'q231', 'q241', 'q26', 'q27'), worry_score, .names = "{col}_score"),
    sum2_score = rowSums(across(q221_score:q27_score), na.rm = TRUE),
    q25 = factor(
      q25,
      levels = c('เคย', 'ไม่เคย', 'อาจจะ, ไม่แน่ใจ'),
      labels = c('Yes', 'No', 'Not sure')
    ),
    across(matches("q3([1-9]|10)1"), ~ factor(
      .x,
      levels = c('กังวลมาก', 'ค่อนข้างกังวล', 'กังวลเล็กน้อย', 'ไม่กังวลเลย'),
      labels = c(
        'Very worried',
        'Somewhat worried',
        'A little worried',
        'Not at all worried'
      )
    )),
    across(matches("q3([1-9]|10)1"), worry_score, .names = "{col}_score"),
    sum3a_score = rowSums(across(c(q311_score:q341_score, 'q361_score', q381_score:q3101_score)), na.rm = TRUE),
    across(matches("q3([1-9]|10)2"), ~ if_else(grepl('^ฉันจะทำ แต่ทำโดยป้องกันเป็นพิเศษมากกว่าการป้องกันตามปกติ',.x),'ฉันจะทำ แต่ทำโดยป้องกันเป็นพิเศษมากกว่าการป้องกันตามปกติ',.x)),
    across(matches("q3([1-9]|10)2"), ~ factor(
      .x,
      levels = c(
        'ฉันจะปฏิเสธ หรือพยายามหาคนอื่นทำแทน',
        'ฉันจะทำ แต่ฉันจะหลีกเลี่ยงการสัมผัสผู้ป่วยให้มากที่สุด',
        'ฉันจะทำ แต่ทำโดยป้องกันเป็นพิเศษมากกว่าการป้องกันตามปกติ',
        'ฉันจะทำเหมือนกับที่ฉันทำให้ผู้ป่วยรายอื่น ๆ'),
      labels = c(
        'Refused',
        'Do, but avoid touching',
        'Do, with extra-precaution',
        'Do as I would with any other'
      )
    )),
    across(matches("q3([1-9]|10)2"), intent_score, .names = "{col}_score"),
    across(matches("q3([1-9]|10)2"), intent_score2, .names = "{col}_score2"),
    q3b = cut(
      rowMeans(
        across(c(q312_score:q342_score, 'q362_score', q382_score:q3102_score)),
        na.rm = TRUE
      ),
      breaks = c(0, 2, Inf),
      labels = c('Score < 2','Score >= 2'),
      right = FALSE
    ),
    q3b_new = cut(
      rowMeans(
        across(c(q312_score:q342_score, 'q362_score', q382_score:q3102_score)),
        na.rm = TRUE
      ),
      breaks = c(0, 2, Inf),
      labels = c('Score <= 2','Score > 2'),
      right = TRUE
    ),
    across(q41:q47, ~ factor(
      .x,
      levels = c('ไม่มี', 'บางคน', 'ส่วนใหญ่', 'ทั้งหมด'),
      labels = c(
        'No one',
        'Some',
        'Most',
        'All'
      )
    )),
    across(q41:q42, norm_score, .names = "{col}_score"),
    across(q43:q47, norm_score_rev, .names = "{col}_score"),
    sum4a_score = rowSums(across(q41_score:q43_score), na.rm = TRUE),
    sum4b_score = rowSums(across(q44_score:q47_score), na.rm = TRUE),
    across(q51:q523, ~ factor(
      .x,
      levels = c(
        'ไม่เห็นด้วยอย่างยิ่ง',
        'ไม่ค่อยเห็นด้วย',
        'ค่อนข้างเห็นด้วย',
        'เห็นด้วยอย่างยิ่ง'),
      labels = c(
        'Strongly disagree',
        'Disagree',
        'Agree',
        'Strongly agree'
      )
      # labels = c(
      #   'Disagree',
      #   'Disagree',
      #   'Agree',
      #   'Agree'
      # )
    )),
    across(
      c('q51', q54:q55, q514:q516, 'q518', q520:q522),
      agree_score_rev,
      .names = "{col}_score"
    ),
    across(
      c(q52:q53, q56:q513, 'q517', 'q519', 'q523'),
      agree_score,
      .names = "{col}_score"
    ),
    # across(
    #   c('q51', q54:q55, q514:q516, 'q518', q520:q522),
    #   agree2g_score_rev,
    #   .names = "{col}_score"
    # ),
    # across(
    #   c(q52:q53, q56:q513, 'q517', 'q519', 'q523'),
    #   agree2g_score,
    #   .names = "{col}_score"
    # ),
    q5 = cut(
      rowMeans(
        across(c(q51_score:q523_score)),
        na.rm = TRUE
      ),
      breaks = c(0, 2, Inf),
      labels = c('Score < 2','Score >= 2'),
      right = FALSE
    ),
    q5_new = cut(
      rowMeans(
        across(c(q51_score:q523_score)),
        na.rm = TRUE
      ),
      breaks = c(0, 2, Inf),
      labels = c('Score <= 2','Score > 2'),
      right = TRUE
    ),
    q5x = cut(
      rowMeans(
        across(c(q51_score:q519_score)),
        na.rm = TRUE
      ),
      breaks = c(0, 2, Inf),
      labels = c('Score < 2','Score >= 2'),
      right = FALSE
    ),
    q5x_new = cut(
      rowMeans(
        across(c(q51_score:q519_score)),
        na.rm = TRUE
      ),
      breaks = c(0, 2, Inf),
      labels = c('Score <= 2','Score > 2'),
      right = TRUE
    ),
    across(q61:q68, ~ factor(
      .x,
      levels = c(
        'ไม่สะดวกใจมาก',
        'ค่อนข้างไม่สะดวกใจ',
        'ค่อนข้างสะดวกใจ',
        'สะดวกใจมาก'),
      labels = c(
        'Very uncomfortable',
        'Somewhat uncomfortable',
        'Somewhat comfortable',
        'Very comfortable'
      )
    )),
    across(q61:q68, comfort_score, .names = "{col}_score"),
    sum6_score = rowSums(across(q61_score:q68_score), na.rm = TRUE),
    across(q71:q79, ~ factor(
      .x,
      levels = c(
        'ถูก',
        'ผิด'),
      labels = c(
        'True',
        'False'
      )
    )),
    across(c('q71','q73','q74','q78','q79'), tf_score, .names = "{col}_score"),
    across(c('q72','q75','q76','q77'), tf_score_rev, .names = "{col}_score"),
    sum7_score = rowSums(across(q71_score:q77_score), na.rm = TRUE),
    across(q81:q811, ~ factor(
      .x,
      levels = c(
        'ถูก',
        'ผิด'),
      labels = c(
        'True',
        'False'
      )
    )),
    across(c(q81:q83,q85:q810), tf_score, .names = "{col}_score"),
    across(c('q84','q811'), tf_score_rev, .names = "{col}_score"),
    across(q812:q816, ~ factor(
      .x,
      levels = c(
        'สำคัญมาก',
        'ค่อนข้างสำคัญ',
        'ไม่ค่อยสำคัญ',
        'ไม่สำคัญเลย'
       ),
      labels = c(
        'Very important',
        'Somewhat important',
        'Not very important',
        'Not important at all'
      )
    )),
    across(q812:q816, important_score, .names = "{col}_score"),
    q8b = if_else(if_all(q812_score:q816_score, ~ .x == 4), 1, 0, missing = 0),
    sum8_score = rowSums(across(q81_score:q811_score), na.rm = TRUE) + q8b,
    across(q91:q97, ~ factor(
      .x,
      levels = c(
        'ไม่มั่นใจ',
        'ไม่ค่อยมั่นใจ',
        'ค่อนข้างมั่นใจ',
        'มั่นใจมาก'),
      labels = c(
        'Very uncertain',
        'Somewhat uncertain',
        'Somewhat certain',
        'Very certain'
      )
    )),
    across(c('q91'), certain_score, .names = "{col}_score"),
    across(q92:q97, certain_score_rev, .names = "{col}_score"),
    across(q101:q107, ~ factor(
      .x,
      levels = c(
        'ทำได้แน่นอน',
        'คิดว่าทำได้',
        'คิดว่าทำไม่ได้',
        'ทำไม่ได้เลย'),
      labels = c(
        'I definitely can',
        'I think I can',
        'Don\'t think I can',
        'I definitely cannot'
      )
    )),
    across(q101:q107, confidence_score, .names = "{col}_score"),
  ) %>%
  set_variable_labels(
    quniv = 'University',
    qtype = 'Type',
    qyear = 'Year of study',
    qyearf = 'Year of study (early or final clinical year)',
    q11 = 'Age (years)',
    agegrp = 'Age group',
    q12 = 'Gender',
    q13 = 'Place of origin (Region)',
    q21 = '2.1 Have you ever contacted/taken care of HIV patients?',
    q211 = '2.1.1 Wear double gloves when taking care PLHIV',
    q212 = '2.1.2 Wear double gloves when taking care other patients',
    q213 = '2.1.3 Use special infection control when taking care PLHIV',
    q214 = '2.1.4 Use special infection control when taking care other patients',
    q221 = '2.2.1 Worried would you be about getting HIV infection if you have to touch the clothing, bedding or belongings',
    q231 = '2.3.1 Worried would you be about getting HIV infection if you have to dress the wounds of HIV/AIDS patients',
    q241 = '2.4.1 Worried would you be about getting HIV infection if you have to draw blood',
    q25 = '2.5 Have you ever been tested for HIV?',
    q26 = '2.6 If you were tested, how worried were you that you might be treated differently or discriminated against if you were to test positive',
    q27 = '2.7 If your test was positive, how worried were you that you might be treated differently or discriminated against if you were to test positive',
    q221_score = 'Score',
    q231_score = 'Score',
    q241_score = 'Score',
    q26_score = 'Score',
    q27_score = 'Score',
    sum2_score = 'Worried about getting HIV infection',
    q311 = "3.1 drawing blood",
    q321 = "3.2 staring IV fluid",
    q331 = "3.3 dressing wound",
    q341 = "3.4 assisting in OR, LR",
    q351 = "3.5 performing chest auscultation",
    q361 = "3.6 performing /assisting in ascetic tap",
    q371 = "3.7 taking blood pressure",
    q381 = "3.8 Administering an injection",
    q391 = "3.9 performing /assisting lumbar puncture",
    q3101 = "3.10 doing urine catheterization",
    q311_score = 'Score',
    q321_score = 'Score',
    q331_score = 'Score',
    q341_score = 'Score',
    q351_score = 'Score',
    q361_score = 'Score',
    q371_score = 'Score',
    q381_score = 'Score',
    q391_score = 'Score',
    q3101_score = 'Score',
    sum3a_score = 'Worried for invasive procedures',
    q312 = "3.1 drawing blood",
    q322 = "3.2 staring IV fluid",
    q332 = "3.3 dressing wound",
    q342 = "3.4 assisting in OR, LR",
    q352 = "3.5 performing chest auscultation",
    q362 = "3.6 performing /assisting in ascetic tap",
    q372 = "3.7 taking blood pressure",
    q382 = "3.8 Administering an injection",
    q392 = "3.9 performing /assisting lumbar puncture",
    q3102 = "3.10 doing urine catheterization",
    q312_score = 'Score',
    q322_score = 'Score',
    q332_score = 'Score',
    q342_score = 'Score',
    q352_score = 'Score',
    q362_score = 'Score',
    q372_score = 'Score',
    q382_score = 'Score',
    q392_score = 'Score',
    q3102_score = 'Score',
    q3b = 'Intention to discriminate while performing invasive procedures',
    q3b_new = 'Intention to discriminate while performing invasive procedures',
    q41 = '4.1 How many would share dishes or glasses with a person with HIV?',
    q42 = '4.2 How many would be comfortable having a person with HIV cooking for them?',
    q43 = '4.3 How many would avoid visiting the homes of people with HIV?',
    q44 = '4.4 How many think that if someone has HIV. It’s due to having engaged in bad behaviors',
    q45 = '4.5 How many think that people with HIV deserve their disease',
    q46 = '4.6 How many think that people with HIV should feel guilty about their infection',
    q47 = '4.7 How many think that people with HIV have brought shame upon their families',
    q41_score = 'Score',
    q42_score = 'Score',
    q43_score = 'Score',
    q44_score = 'Score',
    q45_score = 'Score',
    q46_score = 'Score',
    q47_score = 'Score',
    sum4a_score = 'Total score  4.1 - 4.3',
    sum4b_score = 'Total score  4.4 - 4.7',
    q51 = '5.1 Healthcare workers should be able to refuse to treat a person with HIV.',
    q52 = '5.2 People with HIV should have the right to decide whether or not to disclose their HIV status to their healthcare providers.',
    q53 = '5.3 Employers should not be able to fire a worker living with HIV.',
    q54 = '5.4 Women with the HIV infection should NOT be allowed to marry.',
    q55 = '5.5 Men with the HIV infection should NOT be allowed to marry.',
    q56 = '5.6 A landlord should not have the right to refuse to rent a room to a person with HIV.',
    q57 = '5.7 A man with HIV should have the right to decide whether or not to disclose his HIV status to his wife.',
    q58 = '5.8 A woman with HIV should have the right to decide whether or not to disclose her HIV status to her husband.',
    q59 = '5.9 All female sex workers should be required to be tested for HIV.',
    q510 = '5.10 Women with HIV should have the right to have children.',
    q511 = '5.11 People with HIV should have the right to decide whether or not to disclose their HIV status to their family (other than their spouse).',
    q512 = '5.12 Children with HIV should have the right to attend school.',
    q513 = '5.13 All patients undergoing surgery should be required to be tested for HIV.',
    q514 = '5.14 All medical personnel who perform surgery should be required to be tested for HIV regularly.',
    q515 = '5.15 A patient who has HIV should have a clearly visible label on their medical files, identifying their infection.',
    q516 = '5.16 Other patients in the ward have the right to know if a patient is infected with HIV.',
    q517 = '5.17 PLHIV should have the right to marry other PLHIV.',
    q518 = '5.18 Blood test for HIV without a patient acknowledgement or consent is acceptable.',
    q519 = '5.19 There are adequate supplies in the hospital where you train to help reduce your risk of becoming infected with HIV.',
    q520 = '5.20 Most of PLHIV do not care that they could infect other people.',
    q521 = '5.21 PLHIV should be shamed about their HIV status.',
    q522 = '5.22 People get infected with HIV because they engage in irresponsible or immoral behaviors.',
    q523 = '5.23 Women living with HIV should be allowed to have babies if they wish.',
    q51_score = 'Score',
    q52_score = 'Score',
    q53_score = 'Score',
    q54_score = 'Score',
    q55_score = 'Score',
    q56_score = 'Score',
    q57_score = 'Score',
    q58_score = 'Score',
    q59_score = 'Score',
    q510_score = 'Score',
    q511_score = 'Score',
    q512_score = 'Score',
    q513_score = 'Score',
    q514_score = 'Score',
    q515_score = 'Score',
    q516_score = 'Score',
    q517_score = 'Score',
    q518_score = 'Score',
    q519_score = 'Score',
    q520_score = 'Score',
    q521_score = 'Score',
    q522_score = 'Score',
    q523_score = 'Score',
    q5 = 'Attitudes towards endorsement of coercive policies',
    q5_new = 'Attitudes towards endorsement of coercive policies',
    q5x = 'Attitudes towards endorsement of coercive policies',
    q5x_new = 'Attitudes towards endorsement of coercive policies',
    q61 = '6.1 Visual of Red light district',
    q62 = '6.2 Visual of Anonymous Patients',
    q63 = '6.3 Visual of Transgenders',
    q64 = '6.4 Visual of Homeless',
    q65 = '6.5 Visual of Injecting Drug Users',
    q66 = '6.6 Visual of Truck drivers',
    q67 = '6.7 Visual of Two men hugging suggestively',
    q68 = '6.8 Visual of Immigrant workers',
    q61_score = 'Score',
    q62_score = 'Score',
    q63_score = 'Score',
    q64_score = 'Score',
    q65_score = 'Score',
    q66_score = 'Score',
    q67_score = 'Score',
    q68_score = 'Score',
    q71 = '7.1 HIV is unlikely to be transmitted by having sex with PLHIV and using a condom.',
    q72 = '7.2 HIV can be transmitted by getting an injection with a sterilized syringe and needle.',
    q73 = '7.3 HIV can be transmitted by having sex with PLHIV without using a condom.',
    q74 = '7.4 HIV can be transmitted by sharing drug injection needles with PLHIV.',
    q75 = '7.5 HIV can be transmitted by sharing a glass of drinking water with PLHIV.',
    q76 = '7.6 HIV can be transmitted by using a public toilet that was used by PLHIV.',
    q77 = '7.7 HIV can be transmitted by taking the blood pressure PLHIV without using gloves.',
    q78 = '7.8 HIV can be transmitted by getting a needle prick from a sharp object that has been used on PLHIV.',
    q79 = '7.9 HIV can be transmitted by getting HIV-infected blood splashed onto skin with cuts.',
    q71_score = 'Score',
    q72_score = 'Score',
    q73_score = 'Score',
    q74_score = 'Score',
    q75_score = 'Score',
    q76_score = 'Score',
    q77_score = 'Score',
    q78_score = 'Score',
    q79_score = 'Score',
    sum7_score = 'HIV knowledge',
    q81 = '8.1 Washing hands before and after treating a patient is a standard precaution.',
    q82 = '8.2 Minimizing contact with bodily fluids by wearing Personal Protective Equipment (PPE) is a standard precaution.',
    q83 = '8.3 Wearing single gloves for procedures that require contact with bodily fluids is a standard precaution.',
    q84 = '8.4 Wearing double gloves for procedures that require contact with bodily fluids is a standard precaution.',
    q85 = '8.5 Sterilizing instruments after use is a standard precaution.',
    q86 = '8.6 Using disposable syringes and needles is a standard precaution.',
    q87 = '8.7 Using bleaching powder/sodium hypochlorite to disinfect soiled linen and contaminated waste exposed to bodily fluids is a standard precaution.',
    q88 = '8.8 Disposing sharp instruments and objects into a specific container is a standard precaution.',
    q89 = '8.9 Separating medical and infectious waste from other waste for disposal is a standard precaution.',
    q810 = '8.10 Being careful handling sharp instruments is a standard precaution.',
    q811 = '8.11 Making the patients dispose of their own hazardous waste is a standard precaution.',
    q81_score = 'Score',
    q82_score = 'Score',
    q83_score = 'Score',
    q84_score = 'Score',
    q85_score = 'Score',
    q86_score = 'Score',
    q87_score = 'Score',
    q88_score = 'Score',
    q89_score = 'Score',
    q810_score = 'Score',
    q811_score = 'Score',
    sum8_score = 'Standard precaution on HIV knowledge',
    q812 = '8.12 when they are exposed to body fluids such as blood of patients who have heart disease.',
    q813 = '8.13 when they are exposed to body fluids such as blood of patients who have suspected infections.',
    q814 = '8.14 when they are exposed to body fluids such as blood of patients who have diabetes.',
    q815 = '8.15 when they are exposed to body fluids such as blood of patients who have HIV.',
    q816 = '8.16 when they are exposed to body fluids such as blood of patients who have TB.',
    q812_score = 'Score',
    q813_score = 'Score',
    q814_score = 'Score',
    q815_score = 'Score',
    q816_score = 'Score',
    q91 = '9.1 Washing hands before and after physically examining a patient will prevent you from becoming infected with HIV when caring for PLHIV.',
    q92 = '9.2 Wearing single gloves when drawing a patient’s blood will prevent you from becoming infected with HIV when caring for PLHIV.',
    q93 = '9.3 Using sterilization equipment such as autoclave on instruments after use will prevent you from becoming infected with HIV when caring for PLHIV.',
    q94 = '9.4 Using disposable syringes and needles will prevent you from becoming infected with HIV when caring for PLHIV.',
    q95 = '9.5 Disposing sharp instruments and objects into a specific container will prevent you from becoming infected with HIV when caring for PLHIV.',
    q96 = '9.6 Separating medical and infectious waste from other waste for disposal will prevent you from becoming infected with HIV when caring for PLHIV.',
    q97 = '9.7 PEP (Post Exposure Prophylaxis) drugs after a needle prick will prevent you from becoming infected with HIV when caring for PLHIV.',
    q91_score = 'Score',
    q92_score = 'Score',
    q93_score = 'Score',
    q94_score = 'Score',
    q95_score = 'Score',
    q96_score = 'Score',
    q97_score = 'Score',
    q101 = '10.1 I can notice when someone at my hospital discriminates against PLHIV.',
    q102 = '10.2 I can talk with other students when they make discriminatory comments about PLHIV.',
    q103 = '10.3 I can speak with PLHIV without feeling fear.',
    q104 = '10.4 I can listen to PLHIV without being judgmental.',
    q105 = '10.5 I can touch PLHIV at the hospital without worrying about becoming infected.',
    q106 = '10.6 I can draw blood from PLHIV without becoming infected with HIV.',
    q107 = '10.7 I can dress a wound for PLHIV without becoming infected with HIV.',
    q101_score = 'Score',
    q102_score = 'Score',
    q103_score = 'Score',
    q104_score = 'Score',
    q105_score = 'Score',
    q106_score = 'Score',
    q107_score = 'Score'
  )

df3b <- filter(df, q25 == 'Yes')

df14 <- df %>%
  select(
    q3b,
    q12,
    q13,
    q11,
    qtype,
    # quniv,
    qyearf,
    q21,
    q25,
    sum7_score,
    sum8_score,
    sum3a_score,
    sum2_score) %>%
  drop_na() %>%
  set_variable_labels(
    q21 = 'Have you ever contacted/taken care of HIV patients?',
    q25 = 'Have you ever been tested for HIV?'
  )

df14_new <- df %>%
  select(
    q3b_new,
    q12,
    q13,
    q11,
    qtype,
    # quniv,
    qyearf,
    q21,
    q25,
    sum7_score,
    sum8_score,
    sum3a_score,
    sum2_score) %>%
  drop_na() %>%
  set_variable_labels(
    q21 = 'Have you ever contacted/taken care of HIV patients?',
    q25 = 'Have you ever been tested for HIV?'
  )

df15 <- df %>%
  select(
    q5,
    q12,
    qtype,
    # quniv,
    qyearf,
    q21,
    q25,
    sum7_score,
    sum8_score) %>%
  drop_na() %>%
  set_variable_labels(
    q21 = 'Have you ever contacted/taken care of HIV patients?',
    q25 = 'Have you ever been tested for HIV?'
  )

df15_new <- df %>%
  select(
    q5_new,
    q12,
    qtype,
    # quniv,
    qyearf,
    q21,
    q25,
    sum7_score,
    sum8_score) %>%
  drop_na() %>%
  set_variable_labels(
    q21 = 'Have you ever contacted/taken care of HIV patients?',
    q25 = 'Have you ever been tested for HIV?'
  )

df16 <- df %>%
  select(
    q5x,
    q12,
    qtype,
    # quniv,
    qyearf,
    q21,
    q25,
    sum7_score,
    sum8_score) %>%
  drop_na() %>%
  set_variable_labels(
    q21 = 'Have you ever contacted/taken care of HIV patients?',
    q25 = 'Have you ever been tested for HIV?'
  )

df16_new <- df %>%
  select(
    q5x_new,
    q12,
    qtype,
    # quniv,
    qyearf,
    q21,
    q25,
    sum7_score,
    sum8_score) %>%
  drop_na() %>%
  set_variable_labels(
    q21 = 'Have you ever contacted/taken care of HIV patients?',
    q25 = 'Have you ever been tested for HIV?'
  )

n <- nrow(df)
n3b <- nrow(df3b)
n14 <- nrow(df14)
n15 <- nrow(df15)
```

\newpage

### Table 1: Background characteristics of the participants
(n = `r n`)

```{r t1}
tbl_summary(
  df,
  by = qtype,
  type = list(
    c(q11, sum7_score, sum8_score) ~ 'continuous', 
    q21 ~ "categorical"
  ),
  statistic = list(
    ends_with('_score') ~ "{mean} ({min}, {max})"
  ),
  digits = list(
    q11 ~ c(0, 0, 0),
    ends_with('_score') ~ c(1, 0, 0), 
    all_categorical() ~ c(0, 1)
  ),
  include = c(q12, q11, q13, quniv, qyearf, q25, q21, sum7_score, sum8_score)
) %>%
  add_overall() %>%
  add_p(test.args = all_tests("fisher.test") ~ list(workspace = 2e9)) %>%
  bold_labels() %>%
  bold_p() %>%
  modify_header(label ~ '**Background characteristics**',
                all_stat_cols() ~ "**{level}**<br>N = {n}") %>%
  as_gt() %>%
  tab_options(table.border.bottom.style = 'none')
```

\newpage

### Table 2: Contact with people living with HIV
(n = `r n`)

```{r t2}
tbl_summary(
  df,
  by = qtype,
  type = everything() ~ 'categorical',
  digits = list(all_categorical() ~ c(0, 1)),
  include = c(q21:q214),
  missing = 'no',
  label = q21 ~ '2.1 Contact/take care'
) %>%
  add_overall() %>%
  bold_labels() %>%
  add_p() %>%
  bold_p() %>%
  modify_header(label ~ '',
                all_stat_cols() ~ "**{level}**<br>N = {n}") %>%
  modify_column_indent(columns = label,
                       rows = variable %in% c('q211', 'q212', 'q213', 'q214')) %>%
  modify_column_indent(columns = label,
                       rows = variable %in% c('q211', 'q212', 'q213', 'q214') & row_type == 'level',
                       double_indent = TRUE) %>%
  as_gt() %>%
  tab_options(table.border.bottom.style = 'none')
```

\newpage

### Table 3A: Worried about getting HIV infection
(n = `r n`)

```{r t3a}
tbl_summary(
  df,
  by = qtype,
  type = ends_with('_score') ~ 'continuous',
  statistic = ends_with('_score') ~ 'Sum:{sum} Mean:{mean} (±{sd})',
  digits = list(all_categorical() ~ c(0, 1),
                all_continuous() ~ c(0, 1, 1)),
  include = c(q221, q221_score, q231, q231_score, q241, q241_score),
  missing = 'no'
) %>%
  add_overall() %>%
  bold_labels() %>%
  add_p(ends_with('_score') ~ "t.test") %>%
  bold_p() %>%
  modify_header(label ~ '**How worried when ….**',
                all_stat_cols() ~ "**{level}**<br>N = {n}") %>%
  modify_column_indent(columns = label,
                       rows = var_label == 'Score') %>%
  as_gt() %>%
  tab_options(table.border.bottom.style = 'none')
```

\newpage

### Table 3B: Worried about discriminated against if getting HIV testing
(n = `r n3b`)

```{r t3b}
tbl_summary(
  df3b,
  by = qtype,
  type = ends_with('_score') ~ 'continuous',
  statistic = ends_with('_score') ~ 'Sum:{sum} Mean:{mean} (±{sd})',
  digits = list(all_categorical() ~ c(0, 1),
                all_continuous() ~ c(0, 1, 1)),
  include = c(q26, q26_score, q27, q27_score),
  missing = 'no'
) %>%
  add_overall() %>%
  bold_labels() %>%
  add_p(ends_with('_score') ~ "t.test") %>%
  bold_p() %>%
  modify_header(label ~ '**How worried when ….**',
                all_stat_cols() ~ "**{level}**<br>N = {n}") %>%
  modify_column_indent(columns = label,
                       rows = var_label == 'Score') %>%
  as_gt() %>%
  tab_options(table.border.bottom.style = 'none')
```

\newpage

### Table 4: Professional behaviors - Q3a: How worried
(n = `r n`)

```{r t4}
tbl_summary(
  df,
  by = qtype,
  type = ends_with('_score') ~ 'continuous',
  statistic = ends_with('_score') ~ 'Sum:{sum} Mean:{mean} (±{sd})',
  digits = list(all_categorical() ~ c(0, 1),
                all_continuous() ~ c(0, 1, 1)),
  include = c(q311,q311_score,q321,q321_score,q331,q331_score,q341,q341_score,q351,q351_score,q361,q361_score,q371,q371_score,q381,q381_score,q391,q391_score,q3101,q3101_score),
  missing = 'no'
) %>%
  add_overall() %>%
  bold_labels() %>%
  add_p(ends_with('_score') ~ "t.test") %>%
  bold_p() %>%
  modify_header(label ~ '**How worried when ….**',
                all_stat_cols() ~ "**{level}**<br>N = {n}") %>%
  modify_column_indent(columns = label,
                       rows = var_label == 'Score') %>%
  as_gt() %>%
  tab_options(table.border.bottom.style = 'none')
```

\newpage

### Table 5: Professional behaviors - Q3b: Intent to discriminate
(n = `r n`)

```{r t5}
tbl_summary(
  df,
  by = qtype,
  type = ends_with('_score') ~ 'continuous',
  statistic = ends_with('_score') ~ 'Sum:{sum} Mean:{mean} (±{sd})',
  digits = list(all_categorical() ~ c(0, 1),
                all_continuous() ~ c(0, 1, 1)),
  include = c(q312,q312_score,q322,q322_score,q332,q332_score,q342,q342_score,q352,q352_score,q362,q362_score,q372,q372_score,q382,q382_score,q392,q392_score,q3102,q3102_score),
  missing = 'no'
) %>%
  add_overall() %>%
  bold_labels() %>%
  add_p(ends_with('_score') ~ "t.test") %>%
  bold_p() %>%
  modify_header(label ~ '**Intent to discriminate when ….**',
                all_stat_cols() ~ "**{level}**<br>N = {n}") %>%
  modify_column_indent(columns = label,
                       rows = var_label == 'Score') %>%
  as_gt() %>%
  tab_options(table.border.bottom.style = 'none')
```

\newpage

### Table 6: Professional community norms
(n = `r n`)

```{r t6}
tbl_summary(
  df,
  by = qtype,
  type = ends_with('_score') ~ 'continuous',
  statistic = ends_with('_score') ~ 'Sum:{sum} Mean:{mean} (±{sd})',
  digits = list(all_categorical() ~ c(0, 1),
                all_continuous() ~ c(0, 1, 1)),
  include = c(q41, q41_score,
              q42, q42_score,
              q43, q43_score,
              sum4a_score,
              q44, q44_score,
              q45, q45_score,
              q46, q46_score,
              q47, q47_score,
              sum4b_score),
  missing = 'no'
) %>%
  add_overall() %>%
  bold_labels() %>%
  add_p(ends_with('_score') ~ "t.test") %>%
  bold_p() %>%
  modify_header(label ~ '',
                all_stat_cols() ~ "**{level}**<br>N = {n}") %>%
  modify_column_indent(columns = label,
                       rows = var_label == 'Score') %>%
  as_gt() %>%
  tab_options(table.border.bottom.style = 'none')
```

\newpage

### Table 7: Healthcare policies
(n = `r n`)

```{r t7}
tbl_summary(
  df,
  by = qtype,
  type = ends_with('_score') ~ 'continuous',
  statistic = ends_with('_score') ~ 'Sum:{sum} Mean:{mean} (±{sd})',
  digits = list(all_categorical() ~ c(0, 1),
                all_continuous() ~ c(0, 1, 1)),
  include = c(
                q51,q51_score,
                q52,q52_score,
                q53,q53_score,
                q54,q54_score,
                q55,q55_score,
                q56,q56_score,
                q57,q57_score,
                q58,q58_score,
                q59,q59_score,
                q510,q510_score,
                q511,q511_score,
                q512,q512_score,
                q513,q513_score,
                q514,q514_score,
                q515,q515_score,
                q516,q516_score,
                q517,q517_score,
                q518,q518_score,
                q519,q519_score,
                q520,q520_score,
                q521,q521_score,
                q522,q522_score,
                q523,q523_score),
  missing = 'no'
) %>%
  add_overall() %>%
  bold_labels() %>%
  add_p(ends_with('_score') ~ "t.test") %>%
  bold_p() %>%
  modify_header(label ~ '',
                all_stat_cols() ~ "**{level}**<br>N = {n}") %>%
  modify_column_indent(columns = label,
                       rows = var_label == 'Score') %>%
  as_gt() %>%
  tab_options(table.border.bottom.style = 'none')
```

\newpage

### Table 8: Caring for different populations
(n = `r n`)

```{r t8}
tbl_summary(
  df,
  by = qtype,
  type = ends_with('_score') ~ 'continuous',
  statistic = ends_with('_score') ~ 'Sum:{sum} Mean:{mean} (±{sd})',
  digits = list(all_categorical() ~ c(0, 1),
                all_continuous() ~ c(0, 1, 1)),
  include = c(
              q61,q61_score,
              q62,q62_score,
              q63,q63_score,
              q64,q64_score,
              q65,q65_score,
              q66,q66_score,
              q67,q67_score,
              q68,q68_score
              ),
  missing = 'no'
) %>%
  add_overall() %>%
  bold_labels() %>%
  add_p(ends_with('_score') ~ "t.test") %>%
  bold_p() %>%
  modify_header(label ~ '**How comfortable would you be caring for people, like those seen in this picture, in the hospital? …**',
                all_stat_cols() ~ "**{level}**<br>N = {n}") %>%
  modify_column_indent(columns = label,
                       rows = var_label == 'Score') %>%
  as_gt() %>%
  tab_options(table.border.bottom.style = 'none')
```

\newpage

### Table 10: HIV Transmission
(n = `r n`)

```{r t10}
tbl_summary(
  df,
  by = qtype,
  type = ends_with('_score') ~ 'continuous',
  statistic = ends_with('_score') ~ 'Sum:{sum} Mean:{mean} (±{sd})',
  digits = list(all_categorical() ~ c(0, 1),
                all_continuous() ~ c(0, 1, 1)),
  include = c(
              q71,q71_score,
              q72,q72_score,
              q73,q73_score,
              q74,q74_score,
              q75,q75_score,
              q76,q76_score,
              q77,q77_score,
              q78,q78_score,
              q79,q79_score,
              sum7_score
              ),
  missing = 'no'
) %>%
  add_overall() %>%
  bold_labels() %>%
  add_p(ends_with('_score') ~ "t.test") %>%
  bold_p() %>%
  modify_header(label ~ '',
                all_stat_cols() ~ "**{level}**<br>N = {n}") %>%
  modify_column_indent(columns = label,
                       rows = var_label == 'Score') %>%
  as_gt() %>%
  tab_options(table.border.bottom.style = 'none')
```

\newpage

### Table 11a: Standard precaution knowledge
(n = `r n`)

```{r t11a}
tbl_summary(
  df,
  by = qtype,
  type = ends_with('_score') ~ 'continuous',
  statistic = ends_with('_score') ~ 'Sum:{sum} Mean:{mean} (±{sd})',
  digits = list(all_categorical() ~ c(0, 1),
                all_continuous() ~ c(0, 1, 1)),
  include = c(
              q81,q81_score,
              q82,q82_score,
              q83,q83_score,
              q84,q84_score,
              q85,q85_score,
              q86,q86_score,
              q87,q87_score,
              q88,q88_score,
              q89,q89_score,
              q810,q810_score,
              q811,q811_score,
              sum8_score
              ),
  missing = 'no'
) %>%
  add_overall() %>%
  bold_labels() %>%
  add_p(ends_with('_score') ~ "t.test") %>%
  bold_p() %>%
  modify_header(label ~ '',
                all_stat_cols() ~ "**{level}**<br>N = {n}") %>%
  modify_column_indent(columns = label,
                       rows = var_label == 'Score') %>%
  as_gt() %>%
  tab_options(table.border.bottom.style = 'none')
```

\newpage

### Table 11b: Standard precaution knowledge
(n = `r n`)

```{r t11b}
tbl_summary(
  df,
  by = qtype,
  type = ends_with('_score') ~ 'continuous',
  statistic = ends_with('_score') ~ 'Sum:{sum} Mean:{mean} (±{sd})',
  digits = list(all_categorical() ~ c(0, 1),
                all_continuous() ~ c(0, 1, 1)),
  include = c(
              q812,q812_score,
              q813,q813_score,
              q814,q814_score,
              q815,q815_score,
              q816,q816_score
              ),
  missing = 'no'
) %>%
  add_overall() %>%
  bold_labels() %>%
  add_p(ends_with('_score') ~ "t.test") %>%
  bold_p() %>%
  modify_header(label ~ '**How important is it for healthcare workers to follow standard precautions …**',
                all_stat_cols() ~ "**{level}**<br>N = {n}") %>%
  modify_column_indent(columns = label,
                       rows = var_label == 'Score') %>%
  as_gt() %>%
  tab_options(table.border.bottom.style = 'none')
```

\newpage

### Table 12: Protective measures
(n = `r n`)

```{r t12}
tbl_summary(
  df,
  by = qtype,
  type = ends_with('_score') ~ 'continuous',
  statistic = ends_with('_score') ~ 'Sum:{sum} Mean:{mean} (±{sd})',
  digits = list(all_categorical() ~ c(0, 1),
                all_continuous() ~ c(0, 1, 1)),
  include = c(
              q91,q91_score,
              q92,q92_score,
              q93,q93_score,
              q94,q94_score,
              q95,q95_score,
              q96,q96_score,
              q97,q97_score
              ),
  missing = 'no'
) %>%
  add_overall() %>%
  bold_labels() %>%
  add_p(ends_with('_score') ~ "t.test") %>%
  bold_p() %>%
  modify_header(label ~ '',
                all_stat_cols() ~ "**{level}**<br>N = {n}") %>%
  modify_column_indent(columns = label,
                       rows = var_label == 'Score') %>%
  as_gt() %>%
  tab_options(table.border.bottom.style = 'none')
```

\newpage

### Table 13: Confidence
(n = `r n`)

```{r t13}
tbl_summary(
  df,
  by = qtype,
  type = ends_with('_score') ~ 'continuous',
  statistic = ends_with('_score') ~ 'Sum:{sum} Mean:{mean} (±{sd})',
  digits = list(all_categorical() ~ c(0, 1),
                all_continuous() ~ c(0, 1, 1)),
  include = c(
              q101,q101_score,
              q102,q102_score,
              q103,q103_score,
              q104,q104_score,
              q105,q105_score,
              q106,q106_score,
              q107,q107_score
              ),
  missing = 'no'
) %>%
  add_overall() %>%
  bold_labels() %>%
  add_p(ends_with('_score') ~ "t.test") %>%
  bold_p() %>%
  modify_header(label ~ '**How confident are you that you can carry out each one of these behaviors ….**',
                all_stat_cols() ~ "**{level}**<br>N = {n}") %>%
  modify_column_indent(columns = label,
                       rows = var_label == 'Score') %>%
  as_gt() %>%
  tab_options(table.border.bottom.style = 'none')
```

\newpage

### Table 14: Factor associated with intention to discriminate while performing invasive procedures
(n = `r n14`)

```{r t14}
t_stat <- tbl_summary(
  df14,
  by = q3b,
  type = list(c('q11', ends_with('_score')) ~ 'continuous',
              q21 ~ 'categorical'),
  statistic = list(all_continuous() ~ "{mean} ({min}, {max})"),
  digits = list(all_continuous() ~ c(1, 0, 0)),
) %>%
  add_overall() %>%
  bold_labels() %>%
  modify_header(all_stat_cols() ~ "**{level}**<br>N = {n}")

t_uni <- df14 %>%
  tbl_uvregression(                         # produce univariate table
    method = glm,                           # generalised linear model
    y = q3b,                                # define outcome variable
    method.args = list(family = binomial),  # arguments for glm
    exponentiate = TRUE,                    # exponentiate to produce OR
    hide_n = TRUE                           # hide N column
  ) %>%
  add_global_p() %>%                        # show global p instead
  bold_p(0.15)

fullmodel <- glm(
  q3b ~ q12 + qyearf + sum7_score + sum3a_score + sum2_score,
  family = "binomial",
  data = df14
)
# summary(fullmodel)

nullmodel <- glm(
  q3b ~ 1,
  family = "binomial",
  data = df14
)
# summary(nullmodel)

model1 <- glm(
  q3b ~ qyearf + sum7_score + sum3a_score + sum2_score,
  family = "binomial",
  data = df14
)
# lrtest(fullmodel, model1)
# summary(model1)

model2 <- glm(
  q3b ~ qyearf + sum7_score + sum3a_score,
  family = "binomial",
  data = df14
)
# lrtest(model1, model2)
# summary(model2)

m1 <- step(fullmodel, direction = "backward", trace = FALSE)
m2 <- step(nullmodel, direction = "forward", trace = FALSE,
           scope = list(upper = fullmodel, lower = nullmodel))
m3 <- step(fullmodel, direction="both", trace = FALSE,
           scope = list(upper = fullmodel, lower = nullmodel))
m4 <- step(nullmodel, direction="both", trace = FALSE,
           scope = list(upper = fullmodel, lower = nullmodel))
# lrtest(m1, m2)
# lrtest(m1, m3)
# lrtest(m1, m4)
# summary(m1)

t_multi <- tbl_regression(m1, exponentiate = TRUE) %>%
  add_global_p() %>%                        # show global p instead
  bold_p(0.05)

tbl_merge(
  list(t_stat, t_uni, t_multi),
  tab_spanner = c('Intention to discriminate', 'Univariate', 'Multivariate')
) %>%
  as_gt() %>%
  tab_style(style = cell_text(weight = "bold"), locations = cells_column_spanners())
```

\newpage

```{r t14_new}
t_stat <- tbl_summary(
  df14_new,
  by = q3b_new,
  type = list(c('q11', ends_with('_score')) ~ 'continuous',
              q21 ~ 'categorical'),
  statistic = list(all_continuous() ~ "{mean} ({min}, {max})"),
  digits = list(all_continuous() ~ c(1, 0, 0)),
) %>%
  add_overall() %>%
  bold_labels() %>%
  modify_header(all_stat_cols() ~ "**{level}**<br>N = {n}")

t_uni <- df14_new %>%
  tbl_uvregression(                         # produce univariate table
    method = glm,                           # generalised linear model
    y = q3b_new,                                # define outcome variable
    method.args = list(family = binomial),  # arguments for glm
    exponentiate = TRUE,                    # exponentiate to produce OR
    hide_n = TRUE                           # hide N column
  ) %>%
  add_global_p() %>%                        # show global p instead
  bold_p(0.15)

fullmodel <- glm(
  q3b_new ~ q12 + q13 + q11 + qtype + sum3a_score + sum2_score,
  family = "binomial",
  data = df14_new
)
# summary(fullmodel)

nullmodel <- glm(
  q3b_new ~ 1,
  family = "binomial",
  data = df14_new
)
# summary(nullmodel)

model1 <- glm(
  q3b_new ~ q12 + q11 + qtype + sum3a_score + sum2_score,
  family = "binomial",
  data = df14_new
)
# lrtest(fullmodel, model1)
# summary(model1)

model2 <- glm(
  q3b_new ~ q11 + qtype + sum3a_score + sum2_score,
  family = "binomial",
  data = df14_new
)
# lrtest(model1, model2)
# summary(model2)

model3 <- glm(
  q3b_new ~ q11 + qtype + sum3a_score,
  family = "binomial",
  data = df14_new
)
# lrtest(model2, model3)
# summary(model3)

model4 <- glm(
  q3b_new ~ qtype + sum3a_score,
  family = "binomial",
  data = df14_new
)
# lrtest(model3, model4)
# summary(model4)

m1 <- step(fullmodel, direction = "backward", trace = FALSE)
m2 <- step(nullmodel, direction = "forward", trace = FALSE,
           scope = list(upper = fullmodel, lower = nullmodel))
m3 <- step(fullmodel, direction="both", trace = FALSE,
           scope = list(upper = fullmodel, lower = nullmodel))
m4 <- step(nullmodel, direction="both", trace = FALSE,
           scope = list(upper = fullmodel, lower = nullmodel))
# lrtest(m1, m2)
# lrtest(m1, m3)
# lrtest(m1, m4)
# summary(m1)

t_multi <- tbl_regression(m1, exponentiate = TRUE) %>%
  add_global_p() %>%                        # show global p instead
  bold_p(0.05)

tbl_merge(
  list(t_stat, t_uni, t_multi),
  tab_spanner = c('Intention to discriminate', 'Univariate', 'Multivariate')
) %>%
  as_gt() %>%
  tab_style(style = cell_text(weight = "bold"), locations = cells_column_spanners())
```

\newpage

### Table 15: Factors associated with students attitudes towards endorsement of coercive policies related to HIV stigma (q5.1 - q5.23)
(n = `r n15`)

```{r t15}
t_stat <- tbl_summary(
  df15,
  by = q5,
  type = list(c(ends_with('_score')) ~ 'continuous',
              q21 ~ 'categorical'),
  statistic = list(all_continuous() ~ "{mean} ({min}, {max})"),
  digits = list(all_continuous() ~ c(1, 0, 0)),
) %>%
  add_overall() %>%
  bold_labels() %>%
  modify_header(all_stat_cols() ~ "**{level}**<br>N = {n}")

t_uni <- df15 %>%
  tbl_uvregression(                         # produce univariate table
    method = glm,                           # generalised linear model
    y = q5,                                # define outcome variable
    method.args = list(family = binomial),  # arguments for glm
    exponentiate = TRUE,                    # exponentiate to produce OR
    hide_n = TRUE                           # hide N column
  ) %>%
  add_global_p() %>%                        # show global p instead
  bold_p(0.15)

fullmodel <- glm(
  q5 ~ qtype + qyearf + q21 + sum7_score + sum8_score,
  family = "binomial",
  data = df15
)
# summary(fullmodel)

nullmodel <- glm(
  q5 ~ 1,
  family = "binomial",
  data = df15
)
# summary(nullmodel)

model1 <- glm(
  q5 ~ qtype + qyearf + sum7_score + sum8_score,
  family = "binomial",
  data = df15
)
# lrtest(fullmodel, model1)
# summary(model1)

model2 <- glm(
  q5 ~ qyearf + sum7_score + sum8_score,
  family = "binomial",
  data = df15
)
# lrtest(model1, model2)
# summary(model2)

m1 <- step(fullmodel, direction = "backward", trace = FALSE)
m2 <- step(nullmodel, direction = "forward", trace = FALSE,
           scope = list(upper = fullmodel, lower = nullmodel))
m3 <- step(fullmodel, direction="both", trace = FALSE,
           scope = list(upper = fullmodel, lower = nullmodel))
m4 <- step(nullmodel, direction="both", trace = FALSE,
           scope = list(upper = fullmodel, lower = nullmodel))
# lrtest(m1, m2)
# lrtest(m1, m3)
# lrtest(m1, m4)
# summary(m1)

t_multi <- tbl_regression(m1, exponentiate = TRUE) %>%
  add_global_p() %>%                        # show global p instead
  bold_p(0.05)

tbl_merge(
  list(t_stat, t_uni, t_multi),
  tab_spanner = c('Attitude', 'Univariate', 'Multivariate')
) %>%
  as_gt() %>%
  tab_style(style = cell_text(weight = "bold"), locations = cells_column_spanners())
```

\newpage

```{r t15_new}
t_stat <- tbl_summary(
  df15_new,
  by = q5_new,
  type = list(c(ends_with('_score')) ~ 'continuous',
              q21 ~ 'categorical'),
  statistic = list(all_continuous() ~ "{mean} ({min}, {max})"),
  digits = list(all_continuous() ~ c(1, 0, 0)),
) %>%
  add_overall() %>%
  bold_labels() %>%
  modify_header(all_stat_cols() ~ "**{level}**<br>N = {n}")

t_uni <- df15_new %>%
  tbl_uvregression(                         # produce univariate table
    method = glm,                           # generalised linear model
    y = q5_new,                                # define outcome variable
    method.args = list(family = binomial),  # arguments for glm
    exponentiate = TRUE,                    # exponentiate to produce OR
    hide_n = TRUE                           # hide N column
  ) %>%
  add_global_p() %>%                        # show global p instead
  bold_p(0.15)

fullmodel <- glm(
  q5_new ~ qyearf + sum7_score + sum8_score,
  family = "binomial",
  data = df15_new
)
# summary(fullmodel)

nullmodel <- glm(
  q5_new ~ 1,
  family = "binomial",
  data = df15_new
)
# summary(nullmodel)

m1 <- step(fullmodel, direction = "backward", trace = FALSE)
m2 <- step(nullmodel, direction = "forward", trace = FALSE,
           scope = list(upper = fullmodel, lower = nullmodel))
m3 <- step(fullmodel, direction="both", trace = FALSE,
           scope = list(upper = fullmodel, lower = nullmodel))
m4 <- step(nullmodel, direction="both", trace = FALSE,
           scope = list(upper = fullmodel, lower = nullmodel))
# lrtest(m1, m2)
# lrtest(m1, m3)
# lrtest(m1, m4)
# summary(m1)

t_multi <- tbl_regression(m1, exponentiate = TRUE) %>%
  add_global_p() %>%                        # show global p instead
  bold_p(0.05)

tbl_merge(
  list(t_stat, t_uni, t_multi),
  tab_spanner = c('Attitude', 'Univariate', 'Multivariate')
) %>%
  as_gt() %>%
  tab_style(style = cell_text(weight = "bold"), locations = cells_column_spanners())
```

\newpage

### Table 16: Factors associated with students attitudes towards endorsement of coercive policies related to HIV stigma (q5.1 - q5.19)
(n = `r n15`)

```{r t16}
t_stat <- tbl_summary(
  df16,
  by = q5x,
  type = list(c(ends_with('_score')) ~ 'continuous',
              q21 ~ 'categorical'),
  statistic = list(all_continuous() ~ "{mean} ({min}, {max})"),
  digits = list(all_continuous() ~ c(1, 0, 0)),
) %>%
  add_overall() %>%
  bold_labels() %>%
  modify_header(all_stat_cols() ~ "**{level}**<br>N = {n}")

t_uni <- df16 %>%
  tbl_uvregression(                         # produce univariate table
    method = glm,                           # generalised linear model
    y = q5x,                                # define outcome variable
    method.args = list(family = binomial),  # arguments for glm
    exponentiate = TRUE,                    # exponentiate to produce OR
    hide_n = TRUE                           # hide N column
  ) %>%
  add_global_p() %>%                        # show global p instead
  bold_p(0.15)

fullmodel <- glm(
  q5x ~ qtype + qyearf + sum7_score + sum8_score,
  family = "binomial",
  data = df16
)
# summary(fullmodel)

nullmodel <- glm(
  q5x ~ 1,
  family = "binomial",
  data = df16
)
# summary(nullmodel)

model1 <- glm(
  q5x ~ qyearf + sum7_score + sum8_score,
  family = "binomial",
  data = df16
)
# lrtest(fullmodel, model1)
# summary(model1)

m1 <- step(fullmodel, direction = "backward", trace = FALSE)
m2 <- step(nullmodel, direction = "forward", trace = FALSE,
           scope = list(upper = fullmodel, lower = nullmodel))
m3 <- step(fullmodel, direction="both", trace = FALSE,
           scope = list(upper = fullmodel, lower = nullmodel))
m4 <- step(nullmodel, direction="both", trace = FALSE,
           scope = list(upper = fullmodel, lower = nullmodel))
# lrtest(m1, m2)
# lrtest(m1, m3)
# lrtest(m1, m4)
# summary(m1)

t_multi <- tbl_regression(m1, exponentiate = TRUE) %>%
  add_global_p() %>%                        # show global p instead
  bold_p(0.05)

tbl_merge(
  list(t_stat, t_uni, t_multi),
  tab_spanner = c('Attitude', 'Univariate', 'Multivariate')
) %>%
  as_gt() %>%
  tab_style(style = cell_text(weight = "bold"), locations = cells_column_spanners())
```

\newpage

```{r t16_new}
t_stat <- tbl_summary(
  df16_new,
  by = q5x_new,
  type = list(c(ends_with('_score')) ~ 'continuous',
              q21 ~ 'categorical'),
  statistic = list(all_continuous() ~ "{mean} ({min}, {max})"),
  digits = list(all_continuous() ~ c(1, 0, 0)),
) %>%
  add_overall() %>%
  bold_labels() %>%
  modify_header(all_stat_cols() ~ "**{level}**<br>N = {n}")

t_uni <- df16_new %>%
  tbl_uvregression(                         # produce univariate table
    method = glm,                           # generalised linear model
    y = q5x_new,                                # define outcome variable
    method.args = list(family = binomial),  # arguments for glm
    exponentiate = TRUE,                    # exponentiate to produce OR
    hide_n = TRUE                           # hide N column
  ) %>%
  add_global_p() %>%                        # show global p instead
  bold_p(0.15)

fullmodel <- glm(
  q5x_new ~ qtype + qyearf + sum7_score + sum8_score,
  family = "binomial",
  data = df16_new
)
# summary(fullmodel)

nullmodel <- glm(
  q5x_new ~ 1,
  family = "binomial",
  data = df16_new
)
# summary(nullmodel)

model1 <- glm(
  q5x_new ~ qyearf + sum7_score + sum8_score,
  family = "binomial",
  data = df16_new
)
# lrtest(fullmodel, model1)
# summary(model1)

model2 <- glm(
  q5x_new ~ sum7_score + sum8_score,
  family = "binomial",
  data = df16_new
)
# lrtest(model1, model2)
# summary(model2)

m1 <- step(fullmodel, direction = "backward", trace = FALSE)
m2 <- step(nullmodel, direction = "forward", trace = FALSE,
           scope = list(upper = fullmodel, lower = nullmodel))
m3 <- step(fullmodel, direction="both", trace = FALSE,
           scope = list(upper = fullmodel, lower = nullmodel))
m4 <- step(nullmodel, direction="both", trace = FALSE,
           scope = list(upper = fullmodel, lower = nullmodel))
# lrtest(m1, m2)
# lrtest(m1, m3)
# lrtest(m1, m4)
# summary(m1)

t_multi <- tbl_regression(m1, exponentiate = TRUE) %>%
  add_global_p() %>%                        # show global p instead
  bold_p(0.05)

tbl_merge(
  list(t_stat, t_uni, t_multi),
  tab_spanner = c('Attitude', 'Univariate', 'Multivariate')
) %>%
  as_gt() %>%
  tab_style(style = cell_text(weight = "bold"), locations = cells_column_spanners())
```

\newpage

### Table 17: Internal consistent reliability

```{r alpha}
psych::alpha(select(df, q311_score:q3101_score))
psych::alpha(select(df, q312_score2:q3102_score2))

psych::alpha(select(df, q41_score:q47_score))
psych::alpha(select(df, q41_score:q43_score))
psych::alpha(select(df, q44_score:q47_score))

psych::alpha(select(df, c(q51_score, q52_score:q53_score, q54_score:q55_score, q56_score:q513_score, q514_score:q516_score, q517_score, q518_score, q519_score, q520_score:q522_score, q523_score)))
psych::alpha(select(df, c(q51_score, q52_score:q53_score, q54_score:q55_score, q56_score:q513_score, q514_score:q516_score, q517_score, q518_score, q519_score, q523_score)))
psych::alpha(select(df, c(q520_score:q522_score)))

psych::alpha(select(df, c(q61_score:q68_score)))

psych::alpha(select(df, c(q71_score, q72_score, q73_score:q74_score, q75_score:q77_score, q78_score:q79_score)))

psych::alpha(select(df, c(q81_score:q83_score, q84_score, q85_score:q810_score, q811_score)))
psych::alpha(select(df, c(q812_score:q816_score)))

psych::alpha(select(df, c(q91_score:q97_score)))

psych::alpha(select(df, c(q101_score:q107_score)))
```